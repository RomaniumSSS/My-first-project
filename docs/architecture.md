# Архитектура проекта

## Обзор
Telegram-бот для коучинга и отслеживания целей с использованием AI.

## Технологический стек
- **Язык**: Python 3.11+
- **Бот-фреймворк**: Aiogram 3.x (Async IO)
- **ORM**: Tortoise ORM
- **База данных**: SQLite (для MVP)
- **AI Сервис**: OpenAI API (GPT-4o/GPT-5.1) + Tenacity (Retry logic)
- **Миграции**: Aerich

## Структура проекта
- `src/main.py`: Точка входа.
- `src/bot/handlers/`: Обработчики команд и состояний.
- `src/bot/states.py`: FSM состояния (Onboarding, GoalSetting, CheckIn, Crisis).
- `src/database/models.py`: Модели БД (User, Goal, CheckIn).
- `src/services/`: Внешние сервисы (AI, Vision, GIF).
- `src/data/`: Статические данные (мантры, GIF-файлы).

## Ключевые рабочие процессы (Workflows)

### 1. Онбординг (Onboarding)
Запускается при первом `/start`.
1. **Сбор имени**: Пользователь вводит имя.
2. **Главная цель**: Пользователь вводит первую цель.
3. **Результат**: Создается запись `User` и первая запись `Goal` (status='active').

### 2. Постановка цели (/new_goal)
1. **Заголовок**: Краткое название цели.
2. **Описание**: Детальное описание (Зачем? Как понять успех?).
3. **Визуализация (опционально)**: Фото/Мудборд.
   - Если фото есть: скачивается, конвертируется в Base64, сохраняется в БД.
4. **AI Анализ**:
   - Данные (Текст + Фото) отправляются в OpenAI.
   - Бот возвращает мотивирующий ответ и 3 первых шага.
5. **Сохранение**: Цель сохраняется в БД.

### 3. Ручной Чек-ин (/checkin)
1. **Выбор цели**: Пользователь выбирает активную цель из списка (Inline Buttons).
2. **Отчет**: Пользователь отправляет текст или фото с описанием прогресса.
3. **AI Реакция**:
   - Анализ отчета (Text/Vision) в контексте цели.
   - Генерация похвалы и совета (до 100 слов).
4. **Фиксация**: Запись `CheckIn` (report + feedback) сохраняется в БД.

### 4. Режим Кризиса (/crisis)
Режим поддержки для моментов, когда пользователь находится в тяжёлом состоянии.

**Философия:**
- Без давления — никаких "ты не выполнил план"
- Дыхание первично — сначала выдохнуть, потом думать
- Микро-действие — одно дело на 5-15 минут
- Признание состояния — "тебе тяжело, и это нормально"

**Флоу:**
1. **Вход**: Команда `/crisis` переключает `user.current_mode = 'crisis'`.
2. **Выбор действия**: Inline-кнопки — Подышать / Написать / Просто побыть.
3. **Дыхательные техники**: 
   - 4-7-8 (вдох 4с → задержка 7с → выдох 8с)
   - Box Breathing 4-4-4-4 (более простой вариант)
4. **Микро-действие**: Предложение одного маленького шага (5-15 минут).
5. **Поддержка**: Мантры и GIF-анимации для эмоционального якоря.
6. **Выход**: Команда `/normal` или автоматическое предложение при активности.

**Состояния FSM (CrisisStates):**
- `waiting_for_feeling` — ожидание текста от пользователя
- `breathing` — выполнение дыхательной техники
- `micro_action` — предложение микро-действия
- `just_being` — просто рядом, без требований
- `waiting_for_micro_report` — ожидание отчёта о микро-действии

**Модель User — новые поля:**
- `current_mode`: режим пользователя (normal, crisis, burnout, uncertainty)
- `mode_updated_at`: время последнего изменения режима

### 5. Глубокий поддерживающий диалог (/reflect)
Режим осознанной рефлексии для понимания текущего состояния.

**Философия:**
- Серия осознанных вопросов (7 шт)
- Накопление ответов → LLM анализ
- Персонализированные рекомендации
- Интеграция с практиками (дыхание)

**Флоу:**
1. **Вход**: Команда `/reflect` запускает сессию.
2. **Вопросы** (7 шт MVP):
   - Как себя чувствуешь?
   - Оценка 1-10
   - Что хочешь изменить?
   - Что мешает двигаться?
   - Когда последний раз получалось?
   - Что помогло тогда?
   - Какой маленький шаг сегодня?
3. **LLM Анализ**: Все ответы → OpenAI (эмпатичный коуч).
4. **Результат**: 2-3 персонализированные рекомендации.
5. **Действия**: Кнопки — Подышать / Записать шаг / Готово.

**Состояния FSM (ReflectStates):**
- `q1_feeling` — `q7_one_step` — состояния для каждого вопроса
- `processing` — LLM обработка
- `post_reflect` — после рекомендаций (выбор действия)

**Особенности:**
- Кнопка "Пропустить" для каждого вопроса
- Показ мантры во время ожидания LLM
- Реюз дыхательных техник из crisis.py
- Stateless MVP (без сохранения сессий в БД)
