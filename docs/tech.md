# Техническая Документация

## 1. Общая архитектура

Проект представляет собой асинхронное Telegram-приложение на Python, работающее в режиме Long Polling (в dev; в будущем возможно Webhook в продакшене).  

Архитектура модульная, с разделением на уровни:

- **Bot Service (Сервис бота)**  
  Обрабатывает входящие апдейты Telegram, команды, текст/медиа, маршрутизирует их в нужные хендлеры.
- **Application Logic (Логика приложения)**  
  Реализует бизнес-логику коучинга: работа с целями, чек-инами, геймификацией, статусами пользователей.
- **AI Service (ИИ-сервис)**  
  Абстракция над LLM (OpenAI API) для анализа целей, прогресса и генерации коучинговых рекомендаций.
- **Database (База данных)**  
  Постоянное хранилище для пользователей, целей, логов прогресса, подписок и связанных артефактов.
- **Scheduler (Планировщик)**  
  Фоновый компонент для периодических задач: напоминания, чек-ины, рассылка еженедельных/ежемесячных сводок.

Такое разделение позволяет менять логику коучинга и ИИ без затрагивания хендлеров, а также независимо развивать слой хранения и планировщик.

---

## 2. Технологический стек

### Core

- **Язык:** Python 3.11+ (asyncio)
- **Telegram-фреймворк:** `aiogram 3.x`  
  - асинхронная работа с Telegram Bot API  
  - поддержка FSM для диалогов (онбординг, чек-ины и т.п.)
- **Конфигурация:** `pydantic-settings`  
  - загрузка и валидация переменных окружения из `.env`

### База данных и хранение

- **СУБД:** PostgreSQL  
  - хранение пользователей, целей, чек-инов, подписок, метрик геймификации.
- **ORM:** Tortoise ORM (полностью асинхронная)
- **Миграции:** Aerich
- **Файловое хранилище:**
  - на старте — локальное хранилище (файлы на диске)
  - в будущем — S3-compatible storage для фото целей, мудбордов и «доказательств прогресса».

### AI и обработка

- **LLM Provider:** OpenAI API (или совместимый)
- **Модель:** GPT-4o (мультимодальная — поддержка текста и изображений)  
  - используется для:
    - анализа формулировок целей;
    - интерпретации чек-инов;
    - обработки визуальных мудбордов (фото) в контексте целей;
    - генерации коучинговых советов и микро-шагов.

### Инфраструктура

- **Контейнеризация:** Docker / Docker Compose (опционально, для деплоя)
- **Планирование задач:** `APScheduler` или нативные `asyncio`-таски  
  - для напоминаний, регулярных обзоров, paywall-сообщений.

---

## 3. Ключевые модули и сервисы

### Bot Handlers (слой представления)

Расположены в `src/bot/handlers/`.

- **Onboarding Handlers**  
  - FSM-диалог для сбора первичной анкеты:
    - ключевые цели и направления;
    - сроки/горизонт планирования;
    - мотивация и уровень энергии;
    - предпочтения по частоте и формату напоминаний.
  - Результат: базовый профиль пользователя и начальный контекст для коучинга.

- **Media & Goal Handlers**  
  - Принимают:
    - текстовые описания целей;
    - голосовые заметки (опционально);
    - визуальные мудборды/фото, связанные с целями.
  - Проводят базовую валидацию форматов и размеров.
  - Привязывают медиа к конкретной цели и сохраняют метаданные в БД (с ссылкой на файл).

- **Menu & Progress Handlers**  
  - Управляют:
    - главным меню;
    - переходами к активным целям и профилю;
    - запуском чек-инов (`/checkin`) и просмотром истории прогресса;
    - экраном апгрейда подписки (переход к платным возможностям).
  - Используют inline-кнопки, callback data и FSM для удобной навигации.

### Core Services (бизнес-логика)

Расположены в `src/services/`.

- **Coaching Analysis Service**  
  - Собирает контекст: профиль пользователя, цели, последние чек-ины, мудборды.
  - Формирует промпт для LLM (текст + изображения).
  - Отправляет запрос в OpenAI API и получает структурированный ответ.
  - Нормализует ответ:  
    - состояние пользователя (пример: «перегруз», «стабильное движение», «застревание»);  
    - список рекомендаций и микро-шагов;  
    - уточняющие вопросы к пользователю (при необходимости).
  - Сохраняет полученные данные в БД (как «коучинговую сессию» / инсайт).

- **Payment Service**  
  - Инкапсулирует работу с Telegram Payments.
  - Создаёт инвойсы, валидирует платежи.
  - Обновляет статусы подписок и открывает доступ к платному функционалу:
    - глубокий анализ целей и истории;
    - продвинутые напоминания;
    - еженедельные/ежемесячные обзоры.

Такое разделение позволяет хендлерам быть тонким слоем над бизнес-логикой, а сервисам — оставаться тестируемыми и независимыми от Telegram.

---

## 4. Внешние интеграции

### Telegram Bot API

- Основной интерфейс взаимодействия с пользователем:
  - приём команд (`/start`, `/new_goal`, `/checkin` и др.);
  - получение текстовых сообщений, фото, голосовых;
  - отправка ответов, inline-кнопок, уведомлений;
  - работа с инвойсами через Telegram Payments.
- FSM, реализованная на уровне aiogram, управляет состояниями диалогов (онбординг, создание цели, чек-ин).

### OpenAI API

- Используется endpoint Chat Completions с поддержкой изображений (Vision).
- Основные сценарии:
  - интерпретация формулировок целей и контекста пользователя;
  - анализ чек-инов (что произошло, что помешало, что удалось);
  - использование мудбордов/фото как дополнительного контекста;
  - генерация структурированных коучинговых ответов.
- Системные промпты задают стиль общения (мягкий коучинг, фокус на маленькие шаги, отсутствие медицинских и юридических советов).

---

## 5. Ключевые технические потоки

### 5.1. Онбординг и первичная оценка

1. Пользователь запускает бота (`/start`), FSM переводит его в состояние онбординга.
2. Onboarding Handlers задают последовательность вопросов (цели, сроки, мотивация, предпочтения по напоминаниям).
3. Ответы сохраняются временно (FSM storage), затем — в PostgreSQL через Tortoise ORM.
4. Собранный контекст передаётся в **Coaching Analysis Service** для первичной интерпретации.
5. Пользователь получает краткое саммари и первую точку фокуса.

### 5.2. Цикл ИИ-коучинга (цели и чек-ины)

1. Пользователь создаёт цель (через `/new_goal` или соответствующее меню) или отправляет чек-ин (`/checkin`).
2. Хендлеры валидируют вход (текст/фото), привязывают данные к нужной цели и сохраняют в БД.
3. **Coaching Analysis Service** формирует промпт:
   - история пользователя;
   - текущая цель и её статус;
   - недавно загруженные мудборды и чек-ины.
4. Ответ LLM приводится к нужному формату (поддержка + 1–3 конкретных шага).
5. Бот отправляет ответ пользователю и обновляет метрики геймификации (уровни, стрики и т.п.) в БД.

### 5.3. Уведомления и напоминания

1. Планировщик (APScheduler/async-задачи) срабатывает по заданному расписанию.
2. Сервис напоминаний читает БД:
   - кто давно не делал чек-ин;
   - у кого активные цели без обновлений;
   - учитывает часовые пояса / предпочтения по времени (когда будут реализованы).
3. Через Telegram Bot API отправляются:
   - мягкие напоминания;
   - короткие инсайты (например, «ты уже делал шаги 3 дня подряд»);
   - при необходимости — сообщения с paywall (предложение перейти на подписку).

---

## 6. Безопасность

- **Секреты и ключи**
  - Токен Telegram, ключ OpenAI, параметры подключения к БД хранятся только в переменных окружения (`.env` / системные env).
  - Секреты не логируются и не коммитятся в репозиторий.

- **Изоляция пользовательских данных**
  - Все операции над данными фильтруются по `user_id`.
  - Пользователь не может получить доступ к целям и прогрессу другого пользователя.
  - Доступ к платным возможностям проверяется через статус подписки в БД.

- **Минимизация передаваемого контекста**
  - Во внешние сервисы (OpenAI) отправляется только необходимый контекст:
    - обезличенные описания целей;
    - выдержки чек-инов;
    - ссылки на изображения (или сами изображения, если это нужно для анализа).
  - Логирование персональных данных сведено к минимуму; по умолчанию в логах — только техническая информация и идентификаторы, необходимые для отладки.

