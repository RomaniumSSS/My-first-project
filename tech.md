# Техническая документация

## 1. Системная архитектура

Проект построен как модульный Telegram-бот с использованием асинхронной архитектуры. Он следует многоуровневому дизайну для разделения представления (взаимодействие с Telegram), бизнес-логики (Коучинг/Цели) и сохранения данных.

### Высокоуровневые компоненты
-   **Bot Service (Сервис бота)**: Обрабатывает взаимодействия с пользователем, команды и маршрутизацию сообщений.
-   **Application Logic (Логика приложения)**: Содержит основные бизнес-правила для отслеживания целей, геймификации и уровней пользователей.
-   **AI Service (ИИ-сервис)**: Интерфейс для взаимодействия с Большой Языковой Моделью (LLM) для анализа целей и генерации советов по коучингу.
-   **Database (База данных)**: Постоянное хранилище для пользователей, целей, журналов прогресса и подписок.
-   **Scheduler (Планировщик)**: Фоновый сервис для обработки повторяющихся задач, таких как напоминания, чек-ины и еженедельные сводки.

## 2. Технологический стек

### Ядро
-   **Язык**: Python  3.11+ (AsyncIO)
-   **Фреймворк бота**: `aiogram 3.x` (Асинхронный фреймворк для Telegram Bot API)
Конфигурация: pydantic-settings (валидация переменных окружения .env).

### Данные и хранение
-   **База данных**: PostgreSQL (Реляционные данные для структурированных данных пользователей/целей)
-   ***ORM**: Tortoise ORM (полностью асинхронная ORM).
-   **Миграции**: Aerich
-   **In-Memory хранилище**: Локальное (на старте) или S3-compatible (в будущем) для хранения фото целей и достижений.

### ИИ и обработка
-   **Провайдер LLM**: OpenAI API (или совместимый) для анализа текста и возможностей зрения (мудборды).
-   **Обработка изображений**: 
Модель: GPT-5.1 (выбрана за мультимодальность — способность нативно обрабатывать изображения документов без промежуточного OCR).

### Инфраструктура
-   **Контейнеризация**: Docker и Docker Compose
-   **Планирование**: `APScheduler` (или нативные задачи asyncio) для событий, основанных на времени.

## 3. Ключевые модули и сервисы

### Bot Handlers (слой представления)
- **Onboarding Handlers**: FSM-диалог собирает первичную анкету — цели, сроки, уровень мотивации и предпочтения по напоминаниям. Ответы сохраняются как контекст для персонализации последующих советов.
- **Media & Goal Handlers**: Принимают текст, голосовые заметки и визуальные мудборды, проверяют допустимые форматы и связывают медиа с конкретной целью перед сохранением в хранилище.
- **Menu & Progress Handlers**: Управляют главным меню, быстрым доступом к профилю, активным целям, чек-инам и экраном апгрейда подписки; поддерживают навигацию через inline-кнопки и callback data.

### Core Services (бизнес-логика)
- **Coaching Analysis Service**: Оркестрирует обращение к LLM, подмешивает историю пользователя, последние чек-ины и мудборды, отправляет промпт (включая изображения) и сохраняет структурированный результат (диагноз состояния, советы, микро-шаги).
- **Payment Service**: Инкапсулирует интеграцию с Telegram Payments, проверяет статус оплаты и открывает платные функции (глубокий анализ, расширенные напоминания, долгосрочные планы).

Handlers живут в `src/bot/handlers`, а core-сервисы — в `src/services/`, что обеспечивает чистое разделение представления и бизнес-логики.

## 4. Внешние интеграции

- **Telegram Bot API**: Основной канал общения с пользователем. Через него ведутся FSM-диалоги, принимаются файлы и изображения прогресса, отправляются напоминания и статусы, а также создаются инвойсы Telegram Payments.
- **OpenAI Chat Completions (Vision)**: Провайдер ИИ-аналитики. Используем GPT-5.1 Vision для комбинированных текст+изображение промптов: модель распознаёт содержимое мудбордов, связывает его с контекстом целей и возвращает структурированную коучинговую рекомендацию.

## 5. Ключевые технические потоки

### 5.1. Онбординг и оценка пользователя
1.  Пользователь запускает бота → состояние FSM инициализируется (Redis или in-memory storage).
2.  Onboarding Handlers собирают входные данные (текст/изображения) шаг за шагом.
3.  Накопленные ответы передаются в Coaching Analysis Service для первичной интерпретации.
4.  Сформированный профиль пользователя сохраняется в PostgreSQL через Tortoise ORM.

### 5.2. Цикл ИИ-коучинга
1.  Пользователь отправляет цель или обновление прогресса.
2.  Coaching Analysis Service формирует промпт с учётом истории, личности и свежих мудбордов.
3.  Ответ LLM нормализуется и форматируется под сценарий (советы, микро-шаги, вопросы).
4.  Бот отправляет сообщение пользователю и обновляет метрики геймификации в базе данных.

### 5.3. Уведомления и напоминания
1.  Планировщик (APScheduler/async задачи) срабатывает по расписанию.
2.  Запрашивает базу данных для пользователей с ожидающими чек-инами, учитывая часовые пояса и статус подписки.
3.  Через Bot API отправляются напоминания, инсайты или paywall-сообщения.

## 6. Безопасность

- **Секреты в окружении**: Токен Telegram, ключ OpenAI и учётные данные БД загружаются только из `.env`/переменных окружения, не логируются и не попадают в репозиторий.
- **Изоляция пользовательских данных**: Каждый запрос фильтруется по `user_id`; доступ к прогрессу и целям другого пользователя исключён, а платные ответы выдаются только после успешной проверки подписки.
- **Минимизация экспозиции**: Во внешние сервисы уходит только необходимый контекст (обезличенные выдержки целей и изображения); храним и передаём ссылки на медиа вместо самих файлов, логгирование персональных данных отключено по умолчанию.
