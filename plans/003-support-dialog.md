# 003 - –ì–ª—É–±–æ–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –¥–∏–∞–ª–æ–≥

## Objective
–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º –±–æ—Ç–∞ `/reflect` (–∏–ª–∏ `/support`), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–µ—Ä–∏—é –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (~10), –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–æ–±–ª–µ–º—É –∏ –¥–∞—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ (–¥—ã—Ö–∞–Ω–∏–µ).

---

## –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π User Flow

```
/reflect
    ‚Üì
1. "–ö–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å? –û–ø–∏—à–∏ –æ–¥–Ω–∏–º-–¥–≤—É–º—è —Å–ª–æ–≤–∞–º–∏."
    ‚Üì
2. "–û—Ü–µ–Ω–∏ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç 1 –¥–æ 10"
    ‚Üì
3. "–ß—Ç–æ –±—ã —Ç–µ–±–µ —Ö–æ—Ç–µ–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?"
    ‚Üì
4. "–ß—Ç–æ —Å–µ–π—á–∞—Å –º–µ—à–∞–µ—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥?"
    ‚Üì
5. "–¢—ã —Å–µ–π—á–∞—Å —Å—Ç–æ–∏—à—å –Ω–∞ –º–µ—Å—Ç–µ –∏–ª–∏ –¥–≤–∏–≥–∞–µ—à—å—Å—è?"
    ‚Üì
6. "–ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è?"
    ‚Üì
7. "–ß—Ç–æ —Ç–µ–±–µ –ø–æ–º–æ–≥–ª–æ —Ç–æ–≥–¥–∞?"
    ‚Üì
8. "–ß—Ç–æ –±—ã —Ç—ã —Å–¥–µ–ª–∞–ª, –µ—Å–ª–∏ –±—ã –∑–Ω–∞–ª, —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å?"
    ‚Üì
9. "–ö–∞–∫–æ–π –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?"
    ‚Üì
10. "–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë, —á—Ç–æ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å?"
    ‚Üì
[–í—Å–µ –æ—Ç–≤–µ—Ç—ã ‚Üí LLM]
    ‚Üì
üß† –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    ‚Üì
Inline-–∫–Ω–æ–ø–∫–∏: [üå¨ –ü–æ–¥—ã—à–∞—Ç—å] [üéØ –ó–∞–ø–∏—Å–∞—Ç—å —à–∞–≥] [‚úÖ –ì–æ—Ç–æ–≤–æ]
```

---

## Proposed Steps

### –®–∞–≥ 1: –ù–æ–≤—ã–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
–í `src/bot/states.py` –¥–æ–±–∞–≤–∏—Ç—å:
```python
class ReflectStates(StatesGroup):
    q1_feeling = State()       # –ö–∞–∫ —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è?
    q2_scale = State()         # –û—Ü–µ–Ω–∫–∞ 1-10
    q3_change = State()        # –ß—Ç–æ —Ö–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å?
    q4_obstacle = State()      # –ß—Ç–æ –º–µ—à–∞–µ—Ç?
    q5_movement = State()      # –°—Ç–æ–∏—à—å –∏–ª–∏ –¥–≤–∏–≥–∞–µ—à—å—Å—è?
    q6_last_success = State()  # –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–æ–ª—É—á–∞–ª–æ—Å—å?
    q7_what_helped = State()   # –ß—Ç–æ –ø–æ–º–æ–≥–ª–æ?
    q8_no_fail = State()       # –ï—Å–ª–∏ –±—ã –Ω–µ –º–æ–≥ –ø—Ä–æ–∏–≥—Ä–∞—Ç—å?
    q9_one_step = State()      # –ö–∞–∫–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥?
    q10_extra = State()        # –ß—Ç–æ –µ—â—ë –¥–æ–±–∞–≤–∏—Ç—å?
    processing = State()       # LLM –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

### –®–∞–≥ 2: –ù–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä
–°–æ–∑–¥–∞—Ç—å `src/bot/handlers/reflect.py`:
- –ö–æ–º–∞–Ω–¥–∞ `/reflect` –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–ª–æ—É
- –ö–∞–∂–¥–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Üí –≤–æ–ø—Ä–æ—Å + –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
- –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ `state.update_data()`
- –ü–æ—Å–ª–µ Q10 ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ LLM

### –®–∞–≥ 3: –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM
–°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç "—ç–º–ø–∞—Ç–∏—á–Ω–æ–≥–æ –∫–æ—É—á–∞":
- –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ 10 –æ—Ç–≤–µ—Ç–æ–≤
- –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞/–±–ª–æ–∫–∞
- 3 –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –¢—ë–ø–ª—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ç–æ–Ω

### –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏
–ü–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å:
- üå¨ –ü–æ–¥—ã—à–∞—Ç—å (—Ä–µ—é–∑ breathing –∏–∑ crisis.py)
- üéØ –ó–∞–ø–∏—Å–∞—Ç—å —à–∞–≥ –∫–∞–∫ –º–∏–∫—Ä–æ-—Ü–µ–ª—å
- ‚úÖ –ó–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `ReflectSession` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–π.

---

## Risks

1. **–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥** ‚Äî 10 –≤–æ–ø—Ä–æ—Å–æ–≤ –º–æ–≥—É—Ç —É—Ç–æ–º–∏—Ç—å
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" / –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ—Ä–≤–∞—Ç—å

2. **LLM latency** ‚Äî –∞–Ω–∞–ª–∏–∑ 10 –æ—Ç–≤–µ—Ç–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-15 —Å–µ–∫
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å typing indicator + –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é –º–∞–Ω—Ç—Ä—É

3. **Privacy** ‚Äî –ª—é–¥–∏ –¥–µ–ª—è—Ç—Å—è –ª–∏—á–Ω—ã–º
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–æ–≤, —Ç–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫–∏

---

## Rollback Strategy

- –•–µ–Ω–¥–ª–µ—Ä `/reflect` –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
- –£–¥–∞–ª–µ–Ω–∏–µ: —É–±—Ä–∞—Ç—å —Ä–æ—É—Ç–µ—Ä –∏–∑ main.py, —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
- –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ flows

---

## MVP Scope (v1)

–î–ª—è –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏:
- [ ] 5-7 –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–µ –≤—Å–µ 10)
- [ ] LLM –∞–Ω–∞–ª–∏–∑ + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- [ ] –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—ã—à–∞—Ç—å" –ø–æ—Å–ª–µ
- [ ] –ë–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (stateless)

---

## Acceptance Criteria

1. `/reflect` –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤
2. –ë–æ—Ç –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å
3. –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ ‚Äî LLM –∞–Ω–∞–ª–∏–∑ (‚â§30 —Å–µ–∫)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 2-3 –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—ã—à–∞—Ç—å" –≤–µ–¥—ë—Ç –≤ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É

