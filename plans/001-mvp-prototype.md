# План реализации Прототипа (MVP): AI-коуч бот

**Цель:** Быстро создать работающий прототип для проверки гипотезы (Smoke Test & Alpha Test) на реальных пользователях, используя упрощенный стек (SQLite) и ручное управление прогрессом.

**Статус:** На утверждении

## Этап 0: Smoke Test и Скелет (Day 1)
Цель: Убедиться, что бот запускается, отвечает на команды и деплоится.

1.  **Инициализация:**
    - [x] Настройка `poetry` / `requirements.txt`: `aiogram`, `tortoise-orm`, `aiosqlite`, `aerich`, `openai`, `pydantic-settings`, `tenacity` (для retry).
    - [x] Конфиг `src/config.py`: чтение `.env` (BOT_TOKEN, OPENAI_KEY).
2.  **Минимальный Бот:**
    - [ ] `src/main.py`: Запуск поллинга.
    - [ ] `src/bot/handlers/start.py`: Простой хендлер `/start` -> "Бот работает".
3.  **Деплой/Запуск:**
    - [ ] Локальный запуск и проверка отклика.

## Этап 1: База данных и Модели (SQLite)
Переход на SQLite для простоты развертывания.

1.  **Настройка Tortoise ORM:**
    - [x] Конфигурация на файл `db.sqlite3`.
    - [x] Инициализация `Aerich` для миграций.
2.  **Модели (`src/database/models.py`):**
    - [x] **User**: `telegram_id`, `username`, `first_name`, `created_at`.
    - [x] **Goal**: `user_id`, `title`, `description`, `image_base64` (TextField, храним контент для анализа), `status`, `created_at`.
    - [x] **CheckIn**: `goal_id`, `date`, `report_text`, `ai_feedback` (убран `mood_score`).
3.  **Миграции:**
    - [x] Создание и применение первой схемы.

## Этап 2: AI-Сервис (Core + Reliability)
Реализация "мозга" с учетом отказоустойчивости.

1.  **OpenAI Client Wrapper (`src/services/ai.py`):**
    - [x] Настройка клиента `AsyncOpenAI`.
    - [x] **Retry & Timeout**: Использовать `tenacity` для повторных попыток при ошибках сети/5xx (3 попытки, экспоненциальная задержка). Таймаут запроса 30-60 сек.
    - [x] **Fallback**: Если API недоступен после ретраев -> возвращать заглушку "Мозг коуча сейчас перезагружается, попробуй позже".
    - [x] **Логирование**: Записывать промпт (сокращенно), статус ответа и latency.
2.  **Vision Helper:**
    - [x] Функция скачивания фото из Telegram -> конвертация в Base64.
    - [x] Подготовка payload для GPT-5.1.

## Этап 3: Онбординг и Постановка цели
Основной сценарий использования.

1.  **FSM Onboarding:**
    - [ ] Сбор данных: Имя -> Главная цель (Текст).
2.  **FSM Goal Setting:**
    - [ ] Команда `/new_goal`.
    - [ ] Прием описания и опционально фото (Мудборд).
    - [ ] Конвертация фото в base64 и сохранение в БД (или временно в память для анализа, если база будет пухнуть, но для прототипа пишем в БД).
    - [ ] **AI Анализ**: Отправка данных в сервис -> Получение мотивирующего ответа.
    - [ ] Отправка ответа пользователю.

## Этап 4: Ручной Чек-ин (Manual Accountability)
Замена автоматического планировщика на инициативу пользователя.

1.  **Команда `/checkin`:**
    - [ ] Бот предлагает выбрать активную цель (Inline кнопки).
    - [ ] Пользователь пишет отчет (текст/фото).
2.  **Реакция AI:**
    - [ ] Анализ отчета по сравнению с целью.
    - [ ] Генерация фидбека (похвала + совет).
    - [ ] Сохранение в историю.

## Этап 5: Альфа-тестирование
Проверка на реальных людях.

1.  **Подготовка:**
    - [ ] Инструкция для тестеров (что нажимать, что ожидать).
    - [ ] Выдача доступа (white-list или открытый доступ).
2.  **Сбор обратной связи:**
    - [ ] Логирование ошибок в файл/консоль.
    - [ ] Ручной сбор фидбека от пользователей.

## Дополнительно (Технический долг и Риски)
- **AICODE-NOTE:** Хранение Base64 картинок в SQLite приемлемо только для прототипа (< 100 пользователей). В продакшене нужен S3 (MinIO).
- **Риск:** Токены OpenAI могут быстро закончиться при тестах Vision. *Решение:* Лимиты на пользователя или кэширование ответов (не для MVP).

